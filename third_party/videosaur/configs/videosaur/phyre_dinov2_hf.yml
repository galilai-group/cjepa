# CLEVRER videos: 128 frames, 480x320 resolution. DINOv2-B/14 expects 518x518 inputs.
experiment_group: videosaur_clevrer
experiment_name: clevrer_dinov2

globals:
  NUM_SLOTS: 7
  SLOT_DIM: 128
  DINO_MODEL: vit_small_patch14_dinov2.lvd142m
  FEAT_DIM: 384
  NUM_PATCHES: 196
  NUM_GPUS: 1
  BATCH_SIZE_PER_GPU: 32
  TOTAL_BATCH_SIZE: "${mul: ${.NUM_GPUS}, ${.BATCH_SIZE_PER_GPU}}"
  BASE_LR: 0.0001
  SIM_WEIGHT: 0.1
  SIM_TEMP: 0.15

wandb:
  enable: true
  project: videosaur
  name: ${experiment_name}
  group: ${experiment_group}
  tags: [clevrer, dinov2]
  mode: online


trainer:
  accelerator: gpu
  max_steps: 100000
  log_every_n_steps: 1
  val_check_interval: 1000
  gradient_clip_val: 0.05

optimizer:
  name: Adam
  # Scale learning rate by batch size: take base lr once for every 32 samples
  lr: "${eval_dummy: 'a / 32 * b', ${globals.TOTAL_BATCH_SIZE}, ${globals.BASE_LR}}"
  lr_scheduler:
    name: exp_decay_with_warmup
    warmup_steps: 2000
    decay_steps: ${trainer.max_steps}

model:
  input_type: video
  visualize: true
  visualize_every_n_steps: 10000

  losses:
    loss_featrec:
      name: MSELoss
      pred_dims:
        - 0
        - ${globals.FEAT_DIM}
    loss_timesim:
      name: CrossEntropyLoss
      target_key: encoder.vit_block_keys12
      remove_last_n_frames: 1
      pred_dims:
        - ${globals.FEAT_DIM}
        - "${add: ${globals.FEAT_DIM}, ${globals.NUM_PATCHES}}"
      target_transform:
        name: utils.FeatureTimeSimilarity
        softmax: true
        temperature: ${globals.SIM_TEMP}
        threshold: 0.0
  loss_weights:
    loss_timesim: ${globals.SIM_WEIGHT}
    loss_featrec: 1.0

  initializer:
    name: RandomInit
    n_slots: ${globals.NUM_SLOTS}
    dim: ${globals.SLOT_DIM}

  encoder:
    backbone:
      name: TimmExtractor
      model: ${globals.DINO_MODEL}
      features:
      - vit_block12
      - vit_block_keys12
      frozen: true
      pretrained: true
    output_transform:
      name: networks.two_layer_mlp
      inp_dim: ${globals.FEAT_DIM}
      outp_dim: ${globals.SLOT_DIM}
      hidden_dim: "${mul: ${globals.FEAT_DIM}, 2}"
      layer_norm: true

  grouper:
    name: SlotAttention
    inp_dim: ${globals.SLOT_DIM}
    slot_dim: ${globals.SLOT_DIM}
    n_iters: 2
    use_mlp: false

  latent_processor:
    first_step_corrector_args:
      n_iters: 3

  decoder:
    name: SlotMixerDecoder
    inp_dim: ${globals.SLOT_DIM}
    embed_dim: ${globals.SLOT_DIM}
    outp_dim: "${add: ${globals.FEAT_DIM}, ${globals.NUM_PATCHES}}"
    n_patches: ${globals.NUM_PATCHES}
    allocator:
      name: TransformerEncoder
      dim: ${globals.SLOT_DIM}
      memory_dim: ${globals.SLOT_DIM}
      n_blocks: 3
      n_heads: 4
    renderer:
      name: MLP
      inp_dim: ${globals.SLOT_DIM}
      outp_dim: 1024
      hidden_dims: [1024, 1024]
      final_activation: true
    renderer_dim: 1024
    use_layer_norms: true
    pos_embed_mode: add

  predictor:
    name: networks.TransformerEncoder
    dim: ${globals.SLOT_DIM}
    n_blocks: 1
    n_heads: 4

val_metrics: null

dataset:
  train_shards: "/cs/data/people/hnam16/data/clevrer_wds_mp4/train/clevrer-train_videos-{000000..000019}.tar"
  val_shards: "/cs/data/people/hnam16/data/clevrer_wds_mp4/validation/clevrer-val_videos-{000000..000009}.tar"
  batch_size: ${globals.BATCH_SIZE_PER_GPU}
  val_batch_size: ${globals.BATCH_SIZE_PER_GPU}
  val_size: 200
  num_workers: 5 # increase this if you have more CPU cores
  num_val_workers: 4
  train_pipeline:
    chunk_size: 6
    num_frameskip: 2    # keep every 2nd frame: 0,2,4,...
    keys: [video]
    sample_one_chunk_per_video: true
    transforms:
      name: phyre_train
      type: video
      # crop_type: short_side_resize_random
      input_size: 196
      h_flip_prob: 0.5
  val_pipeline:
    use_chunks: true
    chunk_size: 10
    num_frameskip: 2 
    keys: [video]
    transforms:
      name: phyre_val
      type: video
      # crop_type: central
      input_size: 196
      use_segmentations: false
